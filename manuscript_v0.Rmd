---
title: "Testing new Pauly Cessational Growth Function"
author: "Derek H. Ogle"
date: "April 9, 2016"
output:
  html_document: 
    fig_height: 3.5
    fig_width: 4
  pdf_document:
    fig_caption: yes
csl: american-fisheries-society.csl
bibliography: SeasonalGrowth.bib
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(34738423)  # for reproducibility
library(FSA)
library(FSAsim)

# setup figure, table, and equation captioning
library(captioner)
figcaps <- captioner(prefix="Figure")
tblcaps <- captioner(prefix="Table")
eqncaps <- captioner(prefix="Equation")
eqncaps("VBMain")
eqncaps("SomersMod")
eqncaps("PaulyMod")
eqncaps("PaulyMod2")

vbSO <- vbFuns("Somers2")
```

```{r captions, include=FALSE}

```


```{r maketprFun, echo=FALSE}
################################################################################
## internal function to compute t-prime
## 
################################################################################
iCalc_tpr <- function(t,WP,NGT) {
  ## First NGT stats at WP, use this to shift each age such that
  ##    first NGT would correspond to a value of 1
  tshift <- 1-WP+NGT/2
  tmp.t <- t+tshift
  ## Find fraction of year on this new time scale for each adjusted age
  tmp.t2 <- tmp.t-floor(tmp.t)
  ## Adjust this fraction for no growth
  for (i in 1:length(tmp.t2)) {
    if (tmp.t2[i]<=NGT) tmp.t2[i] <- 0
    else tmp.t2[i] <- tmp.t2[i]-NGT
  }
  tmp.t <- floor(tmp.t)*(1-NGT)+tmp.t2
  ## Shift back to get tprime (why is NGT needed here)
  tpr <- tmp.t-tshift+NGT
}
```


```{r makePaulyFun, echo=FALSE}
################################################################################
## Main Function
##
##   Linf, t0 as usual
##   Kpr = K-prime as defined in Pauly et al. (units are diff than usual K)
##   WP = "Winter Period" (point where growth=0) = ts+0.5 (ts from Pauly et al.)
##   NGT = "No Growth Time" = "fraction of a year where no growth occurs
##
##   tpr = "t-prime" = actual age (t) minus cumulative NGT prior to t
##   Q is as defined in Pauly et al.
##   qt and qtr are intermediate values to make Pauly SC look similar to the
##     Somers and Somers2 models from vbFuns() in FSA
##
##   The final line is basically Equation 4 from Pauly et al.
################################################################################

paulySC <- function(t,Linf,Kpr=NULL,t0=NULL,WP=NULL,NGT=NULL) {
  if (length(Linf)==5) { Kpr <- Linf[[2]]; t0 <- Linf[[3]]
                         WP <- Linf[[4]]; NGT <- Linf[[5]]
                         Linf <- Linf[[1]] }
  tpr <- iCalc_tpr(t,WP,NGT)
  Q <- (2*pi)/(1-NGT)
  qt <- (Kpr/Q)*sin(Q*(tpr-WP+0.5))
  qt0 <- (Kpr/Q)*sin(Q*(t0-WP+0.5))
  Linf*(1-exp(-Kpr*(tpr-t0)-qt+qt0))
}
```

# Introduction

The growth of many animals exhibits seasonal oscillations in response to seasonal changes in temperature, light, and food supplies ().  Several functions have been proposed to model seasonal growth.  The most popular of these functions, from XXX and @Somers1988 and carefully reiterated in @GarciaBerthouetal2012, is

$$ L_{t} = L_{\infty}(1-e^{-q}) \quad \quad \text{`r paste0("(",eqncaps("VBMain",display="num"),")")`} $$

with 

$$ q=K(t-t_{0})+\frac{CK}{2\pi}sin(2\pi(t-t_{s}))-\frac{CK}{2\pi}sin(2\pi(t_{0}-t_{s})) \quad \quad \text{`r paste0("(",eqncaps("SomersMod",display="num"),")")`} $$

where $L(t)$ is the expected or average length at time (or age) $t$, $L_{\infty}$ is the model asymptote for average length, $K$ is a measure of the exponential rate of approach to the asymptotic length [@SchnuteFournier1980], $t_{0}$ is the theoretical time or age (generally negative) at which the average length would be zero, $C$ modulates the amplitude of the growth oscillations and corresponds to the proportion of decrease in growth at the depth of the oscillation (i.e., "winter"), and $t_{s}$ is the time between time 0 and the start of the convex portion of the first sinusoidal growth oscillation (i.e., the inflection point).  If $C$=0, then there is no seasonal oscillation and this function reduces to the typical von Bertalanffy growth function (`r figcaps("SomersExPlot",display="cite")`).  If $C$=1, then growth completely stops once a year at the "winter-point" ($WP=t_{s}+0.5$), whereas values of 0&gt;$C$&lt;1 result in reduced, but not stopped, growth during the winter (`r figcaps("SomersExPlot",display="cite")`).

\ 

```{r echo=FALSE, results="hide"}
par(xaxs="i",yaxs="i",mar=c(3,3,0.6,0.6),mgp=c(1.7,.4,0),tcl=-0.2,las=1)
WP <- 0.8; Linf <- 30; K <- 0.3; t0 <- -0.05
C <- c(0,0.5,1,2)
clr <- col2rgbt(rep("black",4),1/(1:4))
t <- seq(0,3,length.out=299)
plot(vbSO(t,Linf=c(Linf,K,t0,C=C[1],WP))~t,type="l",lwd=2,col=clr[1],
     ylim=c(0,20),ylab="Length",xlab="Age (years)",xaxt="n")
axis(1,0:3)
lines(vbSO(t,Linf=c(Linf,K,t0,C=C[2],WP))~t,lwd=2,col=clr[2])
lines(vbSO(t,Linf=c(Linf,K,t0,C=C[3],WP))~t,lwd=2,col=clr[3])
lines(vbSO(t,Linf=c(Linf,K,t0,C=C[4],WP))~t,lwd=2,col=clr[4])

#WPs <- 0:5+WP
#LatWPs <- vbSO(WPs,Linf=Scf)
#segments(WPs,0,WPs,LatWPs,lty=3,lwd=2,col="red")

legend("topleft",paste("C",C,sep="="),lwd=2,col=clr,bty="n",inset=-0.02)

figcaps("SomersExPlot",paste0("Example growth trajectory of ",eqncaps('VBMain',display='cite')," using ",eqncaps('SomersMod',display='cite')," with $L_{\\infty}$=",Linf,", $K$=",K,", $t_{0}$=",t0,", $t_{s}$=",WP-0.5," (or $WP$=",WP,"), and four different values of $C$."))
```

`r figcaps("SomersExPlot")`

\ 

Values of $C$&gt;1 (or &lt;0) allow seasonal decreases in average length-at-age (`r figcaps("SomersExPlot",display="cite")`).  A seasonal decrease in average length-at-age could result from size-dependent overwinter mortality [@GarciaBerthouetal2012], but this growth trajectory is unlikely for organisms whose skeletons largely preclude shrinkage [@Paulyetal1992].  

@Paulyetal1992 introduced a modification of `r eqncaps("SomersMod")` that modeled a true no-growth period and that smoothly transitioned into and out of the no-growth period.  Specifically, their function is `r eqncaps("VBMain")` with 

\ 

$$ q=K(t^{'}-t_{0})+\frac{K(1-NGT)}{2\pi}sin(\frac{2\pi}{1-NGT}(t^{'}-t_{s}))-\frac{K(1-NGT)}{2\pi}sin(\frac{2\pi}{1-NGT}(t_{0}-t_{s})) \quad \quad \text{`r paste0("(",eqncaps("PaulyMod",display="num"),")")`} $$

\ 

\noindent where $NGT$ is the "no-growth time" or the length of the no growth period (in fractions of a year) and $t^{'}$ is found by "subtracting from the real age ($t$) the total no-growth time occurring up to age $t$."  @Paulyetal1992 introduced $K^{'}$ to `r eqncaps("PaulyMod",display="cite")` as the units of $K$ change from $year^{-1}$ in `r eqncaps("SomersMod",display="cite")` to $(1-NGT)^{-1}$ in `r eqncaps("PaulyMod",display="cite")` because $t^{'}$&lt;$t$ for any $t$.  We further note here that $K^{'}$&gt;$K$ because annual growth is compressed into a shorter period ($1-NGT$) in `r eqncaps("PaulyMod",display="cite")` when $NGT$&gt;0.

@Paulyetal1992 derived  `r eqncaps("PaulyMod",display="cite")` by assuming $C$=1 (i.e., that the rate of growth is 0 at one point), replacing $2\pi$ with $\frac{2\pi}{1-NGT}$ (i.e., restricting the oscillation to the growth period), and replacing $K$ with $K^{'}$.  Furthermore, their modification can be described geometrically (though not algorithmically) in two steps.  First, the seasonal growth function combined in Equations `r eqncaps("VBMain",display="num")` and `r eqncaps("SomersMod",display="num")` with $C$=1 is fit to the observed lengths and ages that have had the cumulative no-growth time subtracted (i.e., the $t^{'}$).  The growth trajectory is then separated at the $WP$ and a segment with a slope of zero that is $NGT$ units long is inserted into the trajectory.  This forms a trajectory that smoothly transitions into and out of a no-growth period (`r figcaps("PaulyExPlot")).

\ 

```{r echo=FALSE, results="hide"}
par(xaxs="i",yaxs="i",mar=c(3,3,0.6,0.6),mgp=c(1.7,.4,0),tcl=-0.2,las=1)
clrs <- c("black",col2rgbt("black",1/2))
WP <- 0.8; NGT <- 0.3
Linf <- 30; Kpr <- 0.4; t0 <- -0.05
Pcf <- c(Linf,Kpr,t0,WP,NGT)
t <- seq(0,3,length.out=299)
PL <- paulySC(t,Linf=Pcf)
plot(PL~t,type="l",lwd=2,ylim=c(0,20),ylab="Length",xlab="Age (years)")
WPs <- 0:3+WP
LatWPs <- paulySC(WPs,Linf=Pcf)
segments(WPs,LatWPs-2,WPs,LatWPs+2,lty=3,lwd=2,col=clrs[1])
segments(WPs-NGT/2,LatWPs-1,WPs-NGT/2,LatWPs+1,lty=3,lwd=2,col=clrs[2])
segments(WPs+NGT/2,LatWPs-1,WPs+NGT/2,LatWPs+1,lty=3,lwd=2,col=clrs[2])
figcaps("PaulyExPlot",paste0("Example growth trajectory of ",eqncaps('VBMain',display='cite')," using ",eqncaps('PaulyMod',display='cite')," with $L_{\\infty}$=",Linf,", $K^{'}$=",Kpr,", $t_{0}$=",t0,", $WP$=",WP,", and $NGT$=",NGT,".  Each $WP$ is marked by the longer vertical lines and the beginning and ending of the no-growth times are marked by the paired shorter vertical lines."))
```

`r figcaps("PaulyExPlot")`

\ 


# Methods
## Simulated Data

```{r echo=FALSE}
WP <- 0.8
NGT <- 0.5
gper <- c(WP+NGT/2-1,WP-NGT/2)*365
## Set some growth parameters
Linf <- 30; K <- 0.3; t0 <- 0
## Actually generate the data (with little variability)
d1 <- vbDataGen(200,Linf=Linf,K=K,t0=t0,maxAge=5,SE=0.01,SD=0.01,paramCV=0.01,
                growth.per=gper,sample.per=c(1,365),lendigs=1)
```


## R Implementation



# Model Fitting
## Simulated Data


```{r echo=FALSE, message=FALSE}
lwrbnd <- c(Linf=0,K=0,t0=-Inf,WP=0,NGT=0)
uprbnd <- c(Linf=Inf,K=Inf,t0=Inf,WP=1,NGT=1)
## Try fitting the PaulySC model
sv <- list(Linf=32,K=0.32,t0=0,WP=0.8,NGT=0.1)
fitP1 <- nls(lenCap~paulySC(ageFracY,Linf,K,t0,WP,NGT),data=d1,
             start=sv,lower=lwrbnd,upper=uprbnd,algorithm="port",control=list(maxiter=100))
## Make a diagnostic plot
plot(lenCap~ageFracY,data=d1,pch=19,col=col2rgbt("black",1/5))
curve(paulySC(x,coef(fitP1)),from=1,to=6,col="red",lwd=3,add=TRUE)
cfs <- coef(fitP1)
WPs <- 1:5+cfs[["WP"]]
LatWPs <- paulySC(WPs,Linf=cfs)
segments(WPs,LatWPs-2,WPs,LatWPs+2,lty=3,lwd=2,col="red")
SNGTs <- WPs-cfs[["NGT"]]/2
ENGTs <- WPs+cfs[["NGT"]]/2
segments(SNGTs,LatWPs-1,SNGTs,LatWPs+1,lty=3,lwd=2,col="blue")
segments(ENGTs,LatWPs-1,ENGTs,LatWPs+1,lty=3,lwd=2,col="blue")
legend("topleft",paste(c("WP","NGT"),c(WP,NGT),sep="="),
       bty="n",inset=-0.02,text.col=c("red","blue"))

cbind(Est=coef(fitP1),confint(fitP1))
```
```{r echo=FALSE}
plot(lenCap~ageFracY,data=d1,pch=19,col=col2rgbt("black",1/5),xlim=c(1.7,1.9),ylim=c(13.425,13.43))
curve(paulySC(x,coef(fitP1)),from=1,to=6,col="red",lwd=3,add=TRUE,n=1001)
segments(WPs,LatWPs-2,WPs,LatWPs+2,lty=3,lwd=2,col="red")
segments(SNGTs,LatWPs-1,SNGTs,LatWPs+1,lty=3,lwd=2,col="blue")
segments(ENGTs,LatWPs-1,ENGTs,LatWPs+1,lty=3,lwd=2,col="blue")

```

```{r echo=FALSE, message=FALSE}
## Try fitting the Somers model
vbSO <- vbFuns("Somers2")
fitSO1 <- nls(lenCap~vbSO(ageFracY,Linf,K,t0,C,WP),data=d1,
               start=list(Linf=32,K=0.32,t0=0,C=0.8,WP=0.8),
               lower=c(Linf=0,K=0,t0=-Inf,C=-1,WP=0),
               upper=c(Linf=Inf,K=Inf,t0=Inf,C=2,WP=1),
               algorithm="port",control=list(maxiter=100),trace=FALSE)
plot(lenCap~ageFracY,data=d1,pch=19,col=col2rgbt("black",1/5))
curve(vbSO(x,coef(fitSO1)),from=1,to=6,col="red",lwd=2,add=TRUE)
cbind(coef(fitSO1),confint(fitSO1))
```

## Real Data

## Appendix


```{r}
<<maketprFun>>
```


```{r}
<<makePaulyFun>>
```
