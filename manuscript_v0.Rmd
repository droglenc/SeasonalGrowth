---
title: "Testing new Pauly Cessational Growth Function"
author: "Derek H. Ogle"
date: "April 9, 2016"
output: 
  pdf_document: 
    fig_caption: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(FSA)
library(FSAsim)

# setup figure, table, and equation captioning
library(captioner)
figcaps <- captioner(prefix="Figure")
tblcaps <- captioner(prefix="Table")
eqncaps <- captioner(prefix="Equation")
vbSO <- vbFuns("Somers2")
```

```{r captions, include=FALSE}

```


```{r maketprFun, echo=FALSE}
################################################################################
## internal function to compute t-prime
## 
################################################################################
iCalc_tpr <- function(t,WP,NGT) {
  ## First NGT stats at WP, use this to shift each age such that
  ##    first NGT would correspond to a value of 1
  tshift <- 1-WP+NGT/2
  tmp.t <- t+tshift
  ## Find fraction of year on this new time scale for each adjusted age
  tmp.t2 <- tmp.t-floor(tmp.t)
  ## Adjust this fraction for no growth
  for (i in 1:length(tmp.t2)) {
    if (tmp.t2[i]<=NGT) tmp.t2[i] <- 0
    else tmp.t2[i] <- tmp.t2[i]-NGT
  }
  tmp.t <- floor(tmp.t)*(1-NGT)+tmp.t2
  ## Shift back to get tprime (why is NGT needed here)
  tpr <- tmp.t-tshift+NGT
}
```


```{r makePaulyFun, echo=FALSE}
################################################################################
## Main Function
##
##   Linf, t0 as usual
##   Kpr = K-prime as defined in Pauly et al. (units are diff than usual K)
##   WP = "Winter Period" (point where growth=0) = ts+0.5 (ts from Pauly et al.)
##   NGT = "No Growth Time" = "fraction of a year where no growth occurs
##
##   tpr = "t-prime" = actual age (t) minus cumulative NGT prior to t
##   Q is as defined in Pauly et al.
##   qt and qtr are intermediate values to make Pauly SC look similar to the
##     Somers and Somers2 models from vbFuns() in FSA
##
##   The final line is basically Equation 4 from Pauly et al.
################################################################################

paulySC <- function(t,Linf,Kpr=NULL,t0=NULL,WP=NULL,NGT=NULL) {
  if (length(Linf)==5) { Kpr <- Linf[[2]]; t0 <- Linf[[3]]
                         WP <- Linf[[4]]; NGT <- Linf[[5]]
                         Linf <- Linf[[1]] }
  tpr <- iCalc_tpr(t,WP,NGT)
  Q <- (2*pi)/(1-NGT)
  qt <- (Kpr/Q)*sin(Q*(tpr-WP+0.5))
  qt0 <- (Kpr/Q)*sin(Q*(t0-WP+0.5))
  Linf*(1-exp(-Kpr*(tpr-t0)-qt+qt0))
}
```

# Introduction

The growth of many animals exhibits seasonal oscillations in response to seasonal changes in temperature, light, and food supplies ().  Several functions have been proposed to model seasonal growth.  The most popular of these functions, from Somers (1988) but carefully reiterated in GBO (), is

\[ L_{t} = L_{\infty}(1-e^{-K(t-t_{0})}-S(t)+S(t_{0}))  \]

with $S(t) = \frac{CK}{2\pi}sin(2\pi(t-t_{s}))$ so that $S(t_{0}) = \frac{CK}{2\pi}sin(2\pi(t_{0}-t_{s}))$ and where $L(t)$ is the expected or average length at time (or age) $t$, $L_{\infty}$ is the model asymptote for average length, $K$ is a measure of the exponential rate of approach to the asymptotic length (Schnute and Fournier 1980), $t_{0}$ is the theoretical time or age (generally negative) at which the average length would be zero, $C$ modulates the amplitude of the growth oscillations and corresponds to the proportion of decrease in growth at the depth of the oscillation (i.e., "winter"), and $t_{s}$ is the time between time 0 and the start of the convex portion of the first sinusoidal growth oscillation (i.e., the inflection point).  If $C$=0, then there is no seasonal oscillation and this function reduces to the typical von Bertalanffy growth function.  If $C$=1, then growth completely stops once a year at the "winter-point" ($WP=t_{s}+0.5$), whereas values of 0&gt;$C$&lt;1 result in reduced, but not stopped, growth during the winter.


Values of C[1 (or\0)
allow seasonal decreases in average length-at-age,
and might not seem realistic in organisms whose
skeletons largely preclude shrinkage (Pauly et al.
1992), but could result from size-dependent overwinter
mortality.


1. Seasonal Growth
1. Somer's Seasonal Growth Function (SoSVBGF)

```{r echo=FALSE, fig.width=5, fig.height=4, fig.cap="Example growth trajectory of Equation X using Linf=30, Kpr=0.7, t0=-0.05, WP=0.8, and NGT=0.4.  The start of each no growth time (i.e, Annual Age+WP) is marked by a red vertical line and the end of each no growth time (i.e., Annual Age+WP+NGT)."}
par(xaxs="i",yaxs="i",mar=c(3,3,0.6,0.6),mgp=c(1.7,.4,0),tcl=-0.2,las=1)
WP <- 0.8; C <- 1
Linf <- 30; K <- 0.7; t0 <- -0.05
Scf <- c(Linf,K,t0,C,WP)
t <- seq(0,5,length.out=299)
SL <- vbSO(t,Linf=Scf)
plot(SL~t,type="l",lwd=2,ylim=c(0,30),ylab="Length",xlab="Age (years)")
Scf <- c(Linf,K,t0,C=2,WP)
SL <- vbSO(t,Linf=Scf)
lines(SL~t,lwd=2,lty=2)
Scf <- c(Linf,K,t0,C=0.2,WP)
SL <- vbSO(t,Linf=Scf)
lines(SL~t,lwd=2,lty=3)

WPs <- 0:5+WP
LatWPs <- vbSO(WPs,Linf=Scf)
segments(WPs,0,WPs,LatWPs,lty=3,lwd=2,col="red")

legend("topleft",c("C=1","C=2","C=0.2"),lwd=2,lty=1:3,bty="n",inset=-0.02)
```


1. Pauly's Seasonal Growth Function (PaSVBGF)
    1. Define terms
    1. Explain t-prime
    1. Explain K-prime

```{r echo=FALSE, fig.width=5, fig.height=4, fig.cap="Example growth trajectory of Equation X using Linf=30, Kpr=0.7, t0=-0.05, WP=0.8, and NGT=0.4.  The start of each no growth time (i.e, Annual Age+WP) is marked by a red vertical line and the end of each no growth time (i.e., Annual Age+WP+NGT)."}
par(xaxs="i",yaxs="i",mar=c(3,3,0.6,0.6),mgp=c(1.7,.4,0),tcl=-0.2,las=1)
WP <- 0.8; NGT <- 0.4
Linf <- 30; Kpr <- 0.7; t0 <- -0.05
Pcf <- c(Linf,Kpr,t0,WP,NGT)
t <- seq(0,5,length.out=299)
PL <- paulySC(t,Linf=Pcf)
plot(PL~t,type="l",lwd=2,ylim=c(0,30),ylab="Length",xlab="Age (years)")
WPs <- 0:5+WP
LatWPs <- paulySC(WPs,Linf=Pcf)
segments(WPs,0,WPs,LatWPs,lty=3,lwd=2,col="red")
segments(WPs+NGT,0,WPs+NGT,LatWPs,lty=3,lwd=2,col="blue")
legend("topleft",c("WP=0.8","NGT=0.4"),bty="n",inset=-0.02,text.col=c("red","blue"))
```



# Methods
## Simulated Data

```{r echo=FALSE}
WP <- 0.8
NGT <- 0.5
gper <- c(WP+NGT/2-1,WP-NGT/2)*365
## Set some growth parameters
Linf <- 30; K <- 0.3; t0 <- 0
## Actually generate the data (with little variability)
d1 <- vbDataGen(200,Linf=Linf,K=K,t0=t0,maxAge=5,SE=0.01,SD=0.01,paramCV=0.01,
                growth.per=gper,sample.per=c(1,365),lendigs=1)
```


## R Implementation



# Model Fitting
## Simulated Data


```{r echo=FALSE, message=FALSE}
lwrbnd <- c(Linf=0,K=0,t0=-Inf,WP=0,NGT=0)
uprbnd <- c(Linf=Inf,K=Inf,t0=Inf,WP=1,NGT=1)
## Try fitting the PaulySC model
sv <- list(Linf=32,K=0.32,t0=0,WP=0.8,NGT=0.1)
fitP1 <- nls(lenCap~paulySC(ageFracY,Linf,K,t0,WP,NGT),data=d1,
             start=sv,lower=lwrbnd,upper=uprbnd,algorithm="port",control=list(maxiter=100))
## Make a diagnostic plot
plot(lenCap~ageFracY,data=d1,pch=19,col=col2rgbt("black",1/5))
curve(paulySC(x,coef(fitP1)),from=1,to=6,col="red",lwd=3,add=TRUE)
cfs <- coef(fitP1)
WPs <- 1:5+cfs[["WP"]]
LatWPs <- paulySC(WPs,Linf=cfs)
segments(WPs,LatWPs-2,WPs,LatWPs+2,lty=3,lwd=2,col="red")
SNGTs <- WPs-cfs[["NGT"]]/2
ENGTs <- WPs+cfs[["NGT"]]/2
segments(SNGTs,LatWPs-1,SNGTs,LatWPs+1,lty=3,lwd=2,col="blue")
segments(ENGTs,LatWPs-1,ENGTs,LatWPs+1,lty=3,lwd=2,col="blue")
legend("topleft",paste(c("WP","NGT"),c(WP,NGT),sep="="),
       bty="n",inset=-0.02,text.col=c("red","blue"))

cbind(Est=coef(fitP1),confint(fitP1))
```
```{r echo=FALSE}
plot(lenCap~ageFracY,data=d1,pch=19,col=col2rgbt("black",1/5),xlim=c(1.7,1.9),ylim=c(13.425,13.43))
curve(paulySC(x,coef(fitP1)),from=1,to=6,col="red",lwd=3,add=TRUE,n=1001)
segments(WPs,LatWPs-2,WPs,LatWPs+2,lty=3,lwd=2,col="red")
segments(SNGTs,LatWPs-1,SNGTs,LatWPs+1,lty=3,lwd=2,col="blue")
segments(ENGTs,LatWPs-1,ENGTs,LatWPs+1,lty=3,lwd=2,col="blue")

```

```{r echo=FALSE, message=FALSE}
## Try fitting the Somers model
vbSO <- vbFuns("Somers2")
fitSO1 <- nls(lenCap~vbSO(ageFracY,Linf,K,t0,C,WP),data=d1,
               start=list(Linf=32,K=0.32,t0=0,C=0.8,WP=0.8),
               lower=c(Linf=0,K=0,t0=-Inf,C=-1,WP=0),
               upper=c(Linf=Inf,K=Inf,t0=Inf,C=2,WP=1),
               algorithm="port",control=list(maxiter=100),trace=FALSE)
plot(lenCap~ageFracY,data=d1,pch=19,col=col2rgbt("black",1/5))
curve(vbSO(x,coef(fitSO1)),from=1,to=6,col="red",lwd=2,add=TRUE)
cbind(coef(fitSO1),confint(fitSO1))
```

## Real Data

## Appendix


```{r}
<<maketprFun>>
```


```{r}
<<makePaulyFun>>
```
